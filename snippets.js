import { connect } from 'cloudflare:sockets';

// =============================================================================
// ğŸŸ£ ç”¨æˆ·é…ç½®åŒºåŸŸ ã€è¯·æ‰‹åŠ¨ä¿®æ”¹ä¸‹æ–¹å‚æ•°ã€‘
// =============================================================================
const UUID = "06b65903-406d-4a41-8463-6fd5c0ee7798"; // ä¿®æ”¹å¯ç”¨çš„uuid
const WEB_PASSWORD = "123456";  //è‡ªå·±è¦ä¿®æ”¹è‡ªå®šä¹‰çš„ç™»å½•å¯†ç 
const SUB_PASSWORD = "123456";  // è‡ªå·±è¦ä¿®æ”¹è‡ªå®šä¹‰çš„è®¢é˜…å¯†ç 
const DEFAULT_PROXY_IP = "ProxyIP.US.CMLiussss.net";  //å¯ä¿®æ”¹è‡ªå®šä¹‰çš„proxyip
const DEFAULT_SUB_DOMAIN = "sub.cmliussss.net";  //å¯ä¿®æ”¹è‡ªå®šä¹‰çš„subè®¢é˜…å™¨
const TG_GROUP_URL = "https://t.me/zyssadmin";   //å¯ä¿®æ”¹è‡ªå®šä¹‰å†…å®¹
const TG_CHANNEL_URL = "https://t.me/cloudflareorg";  //å¯æ­¤ä¿®æ”¹è‡ªå®šä¹‰å†…å®¹
const PROXY_CHECK_URL = "https://kaic.hidns.co/";  //å¯ä¿®æ”¹è‡ªå®šä¹‰çš„proxyipæ£€æµ‹ç«™
const DEFAULT_CONVERTER = "https://subapi.cmliussss.net";  //å¯ä¿®æ”¹è‡ªå®šä¹‰åç«¯api
const CLASH_CONFIG = "https://raw.githubusercontent.com/cmliu/ACL4SSR/main/Clash/config/ACL4SSR_Online_Full_MultiMode.ini"; //å¯ä¿®æ”¹è‡ªå®šä¹‰è®¢é˜…é…ç½®è½¬æ¢ini
const SINGBOX_CONFIG_V12 = "https://raw.githubusercontent.com/sinspired/sub-store-template/main/1.12.x/sing-box.json"; //ç¦æ­¢ä¿®æ”¹ ä¼˜å…ˆä½¿ç”¨1.12 åç”¨1.11
const SINGBOX_CONFIG_V11 = "https://raw.githubusercontent.com/sinspired/sub-store-template/main/1.11.x/sing-box.json"; //ç¦æ­¢ä¿®æ”¹
const TG_BOT_TOKEN = ""; //ä½ çš„æœºå™¨äººtoken
const TG_CHAT_ID = "";  //ä½ çš„TG ID
const ADMIN_IP   = "";  //ä½ çš„ç™½åå•IP ä¿æŠ¤ä½ ä¸ä¼šè¢«è‡ªå·±åŸŸåæ‹‰é»‘ (æ”¯æŒå¤šIPï¼ŒIPV4è·ŸIPV6 ä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”)

// æ ¸å¿ƒé€»è¾‘ ã€æ–°å¢å…¨å±€ã€‘
const MAX_PENDING=2097152,KEEPALIVE=15e3,STALL_TO=8e3,MAX_STALL=12,MAX_RECONN=24;
const buildUUID=(a,i)=>Array.from(a.slice(i,i+16)).map(n=>n.toString(16).padStart(2,'0')).join('').replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/,'$1-$2-$3-$4-$5');
const extractAddr=b=>{const o1=18+b[17]+1,p=(b[o1]<<8)|b[o1+1],t=b[o1+2];let o2=o1+3,h,l;switch(t){case 1:l=4;h=b.slice(o2,o2+l).join('.');break;case 2:l=b[o2++];h=new TextDecoder().decode(b.slice(o2,o2+l));break;case 3:l=16;h=`[${Array.from({length:8},(_,i)=>((b[o2+i*2]<<8)|b[o2+i*2+1]).toString(16)).join(':')}]`;break;default:throw new Error('Invalid address type.');}return{host:h,port:p,payload:b.slice(o2+l),addressType:t};};
const parseAddressPort=(seg)=>{if(seg.startsWith("[")){const m=seg.match(/^\[(.+?)\]:(\d+)$/);if(m)return[m[1],Number(m[2])];return[seg.slice(1,-1),443];}const[addr,port=443]=seg.split(":");return[addr,Number(port)];};
const socks5AddressParser=(raw)=>{let username,password,hostname,port;if(raw.includes('://')&&!raw.match(/^(socks5?|https?):\/\//i)){const u=new URL(raw);hostname=u.hostname;port=u.port||(u.protocol==='http:'?80:1080);const auth=u.username||u.password?`${u.username}:${u.password}`:u.username;if(auth&&auth.includes(':'))[username,password]=auth.split(':');else if(auth){try{const dec=atob(auth.replace(/%3D/g,'=').padEnd(auth.length+(4-auth.length%4)%4,'='));const p=dec.split(':');if(p.length===2)[username,password]=p;}catch{}}}else{let authPart='',hostPart=raw;const at=raw.lastIndexOf('@');if(at!==-1){authPart=raw.substring(0,at);hostPart=raw.substring(at+1);}if(authPart&&!authPart.includes(':')){try{const dec=atob(authPart.replace(/%3D/g,'=').padEnd(authPart.length+(4-authPart.length%4)%4,'='));const p=dec.split(':');if(p.length===2)[username,password]=p;}catch{}}if(!username&&authPart&&authPart.includes(':'))[username,password]=authPart.split(':');const[h,p]=parseAddressPort(hostPart);hostname=h;port=p||(raw.includes('http=')?80:1080);}if(!hostname||isNaN(port))throw new Error("Invalid proxy config");return{username,password,hostname,port};};
async function socks5Connect(addressType,addressRemote,portRemote,cfg){const{username,password,hostname,port}=cfg;const socket=connect({hostname,port});const writer=socket.writable.getWriter();await writer.write(new Uint8Array([5,username?2:1,0,username?2:0]));const reader=socket.readable.getReader();const enc=new TextEncoder();let resp=(await reader.read()).value;if(resp[1]===2){const auth=new Uint8Array([1,username.length,...enc.encode(username),password.length,...enc.encode(password)]);await writer.write(auth);resp=(await reader.read()).value;if(resp[1]!==0)throw new Error("SOCKS5 auth failed");}let DST;if(addressType===1)DST=new Uint8Array([1,...addressRemote.split(".").map(Number)]);else if(addressType===2)DST=new Uint8Array([3,addressRemote.length,...enc.encode(addressRemote)]);else if(addressType===3){const bytes=addressRemote.slice(1,-1).split(':').flatMap(h=>[parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16)]);DST=new Uint8Array([4,...bytes]);}await writer.write(new Uint8Array([5,1,0,...DST,(portRemote>>8)&0xff,portRemote&0xff]));resp=(await reader.read()).value;if(resp[1]!==0)throw new Error("SOCKS5 connect failed");writer.releaseLock();reader.releaseLock();return socket;}
async function httpConnect(addressType,addressRemote,portRemote,cfg){const{username,password,hostname,port}=cfg;const sock=connect({hostname,port});let req=`CONNECT ${addressRemote}:${portRemote} HTTP/1.1\r\nHost: ${addressRemote}:${portRemote}\r\n`;if(username&&password){req+=`Proxy-Authorization: Basic ${btoa(`${username}:${password}`)}\r\n`;}req+=`User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36\r\nConnection: keep-alive\r\n\r\n`;const writer=sock.writable.getWriter();await writer.write(new TextEncoder().encode(req));writer.releaseLock();const reader=sock.readable.getReader();let buf=new Uint8Array(0);while(true){const{value,done}=await reader.read();if(done)throw new Error("HTTP proxy closed unexpectedly");const tmp=new Uint8Array(buf.length+value.length);tmp.set(buf);tmp.set(value,buf.length);buf=tmp;if(buf.length>65536)throw new Error("HTTP proxy response too large");const txt=new TextDecoder().decode(buf);if(txt.includes("\r\n\r\n")){if(/^HTTP\/1\.[01] 2/i.test(txt.split("\r\n")[0])){reader.releaseLock();return sock;}throw new Error(`HTTP proxy refused: ${txt.split("\r\n")[0]}`);}}}
function parseProxyConfig(path){let proxyIP=null,socks5=null,enableSocks=null,globalProxy=null;const globalMatch=path.match(/(socks5?|https?):\/\/([^/#?]+)/i);if(globalMatch){const cfg=socks5AddressParser(globalMatch[2]);globalProxy={type:globalMatch[1].toLowerCase().includes('5')||globalMatch[1]==='socks'?'socks5':'http',cfg};return{proxyIP,socks5,enableSocks,globalProxy};}const ipMatch=path.match(/(?:^|\/)(?:proxy)?ip[=\/]([^?#]+)/i);if(ipMatch){const seg=ipMatch[1];const[addr,port=443]=parseAddressPort(seg);proxyIP={address:addr.includes('[')?addr.slice(1,-1):addr,port:+port};}const localMatch=path.match(/(?:^|\/)(socks5?|s5|http)[=\/]([^/#?]+)/i);if(localMatch){const seg=localMatch[2];socks5=socks5AddressParser(seg);enableSocks=localMatch[1].toLowerCase().includes('http')?'http':'socks5';}return{proxyIP,socks5,enableSocks,globalProxy};}
async function parseIP(e){e=e.toLowerCase();let t=e,r=443;if(e.includes(".tp")){const n=e.match(/\.tp(\d+)/);if(n)r=parseInt(n[1],10);return[t,r]}if(e.includes("]:")){const n=e.split("]:");t=n[0]+"]",r=parseInt(n[1],10)||r}else if(e.includes(":")&&!e.startsWith("[")){const n=e.lastIndexOf(":");t=e.slice(0,n),r=parseInt(e.slice(n+1),10)||r}return[t,r]}
class Pool{constructor(){this.b=new ArrayBuffer(16384),this.p=0,this.l=[],this.m=8,this.large=false}alloc(e){if(e<=4096&&e<=16384-this.p){const t=new Uint8Array(this.b,this.p,e);return this.p+=e,t}const t=this.l.pop();return t&&t.byteLength>=e?new Uint8Array(t.buffer,0,e):new Uint8Array(e)}free(e){e.buffer===this.b?this.p=Math.max(0,this.p-e.length):this.l.length<this.m&&e.byteLength>=1024&&this.l.push(e)}enableLarge(){this.large=true;}reset(){this.p=0,this.l=[],this.large=false;}}

async function sendTgMsg(e,t,r,n=""){if(!TG_BOT_TOKEN||!TG_CHAT_ID||!r||!r.headers)return;try{const a=new URL(r.url),s=r.headers.get("cf-connecting-ip")||"Unknown",o=(r.headers.get("User-Agent")||"Unknown").toLowerCase();if(o.includes("cloudflare-workers-preview")||"127.0.0.1"===s||s.startsWith("2a06:98c0"))return;const i=r.cf?.city||"Unknown",c=new Date().toLocaleString("zh-CN",{timeZone:"Asia/Shanghai"}),l=e=>(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),p=(ADMIN_IP && ADMIN_IP.split(',').some(x => x.trim() === s))?"ğŸ›¡ï¸ [ç®¡ç†å‘˜]":"ğŸ‘¤ [ç”¨æˆ·]",d=`<b>${p} ${l(t)}</b>\n\n<b>ğŸ•’ æ—¶é—´:</b> <code>${c}</code>\n<b>ğŸŒ IP:</b> <code>${l(s)} (${l(i)})</code>\n<b>ğŸ”— åŸŸå:</b> <code>${l(a.hostname)}</code>\n<b>ğŸ›£ï¸ è·¯å¾„:</b> <code>${l(a.pathname)}</code>\n<b>ğŸ“± å®¢æˆ·ç«¯:</b> <code>${l(r.headers.get("User-Agent"))}</code>\n`+(n?`<b>â„¹ï¸ è¯¦æƒ…:</b> ${l(n)}`:""),u={chat_id:TG_CHAT_ID,text:d,parse_mode:"HTML",disable_web_page_preview:!0};return fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}).catch(e=>console.error("TG Send Error:",e))}catch(e){console.error("TG Setup Error:",e)}}

export default{async fetch(req,env,ctx){try{const url=new URL(req.url),host=url.hostname,UA=(req.headers.get("User-Agent")||"").toLowerCase(),clientIP=req.headers.get("cf-connecting-ip")||"Unknown";
const isWS = req.headers.get("Upgrade") === "websocket";
const isSubPath = (SUB_PASSWORD && url.pathname === `/${SUB_PASSWORD}`);
if(!isSubPath && /bot|spider|python|curl|wget|crawler/i.test(UA))return new Response("403 Forbidden",{status:403});
if("/favicon.ico"===url.pathname)return new Response(null,{status:404});const flag=url.searchParams.get("flag");if("github"===flag)return await sendTgMsg(ctx,"ç‚¹å‡»äº†çƒˆç«é¡¹ç›®",req,"æ¥æº: ç™»å½•é¡µé¢ç›´è¾¾é“¾æ¥"),new Response(null,{status:204});if("proxycheck"===flag)return await sendTgMsg(ctx,"ğŸ› ï¸ ç‚¹å‡»äº†ProxyIPæ£€æµ‹ç«™",req,"ç®¡ç†å‘˜æ“ä½œ"),new Response(null,{status:204});if("test"===flag)return await sendTgMsg(ctx,"ğŸš€ ç‚¹å‡»äº†æ‰‹åŠ¨è®¢é˜…æµ‹è¯•",req,"ç®¡ç†å‘˜æ“ä½œ"),new Response(null,{status:204});

if(isSubPath){
    const isFlagged=url.searchParams.has("flag"), now=Date.now();
    const _d = s => atob(s);
    const clientRules = [
        ['TWlob21v', 'bWlob21v'],['RmxDbGFzaA==', 'ZmxjbGFzaA=='],['Q2xhc2g=', 'Y2xhc2g='],['Q2xhc2g=', 'bWV0YQ=='],['Q2xhc2g=', 'c3Rhc2g='],['SGlkZGlmeQ==', 'aGlkZGlmeQ=='],['U2luZy1ib3g=', 'c2luZy1ib3g='],['U2luZy1ib3g=', 'c2luZ2JveA=='],['U2luZy1ib3g=', 'c2Zp'],['U2luZy1ib3g=', 'Ym94'],['djJyYXlOL0NvcmU=', 'djJyYXk='],['U3VyZ2U=', 'c3VyZ2U='],['UXVhbnR1bXVsdCBY', 'cXVhbnR1bXVsdA=='],['U2hhZG93cm9ja2V0', 'c2hhZG93cm9ja2V0'],['TG9vbg==', 'bG9vbg=='],['SGFB', 'aGFwcA==']
    ];
    let clientName = "æœªçŸ¥å®¢æˆ·ç«¯";
    let isProxyClient = false;
    for (const [name64, key64] of clientRules) {
        if (UA.includes(_d(key64))) {
            clientName = _d(name64);
            isProxyClient = true;
            break;
        }
    }
    if (!isProxyClient && (UA.includes("mozilla") || UA.includes("chrome"))) {
        clientName = "æµè§ˆå™¨";
    }
    if(!isFlagged){
        const title = isProxyClient ? "ğŸ”„ å¿«é€Ÿè®¢é˜…æ›´æ–°" : "ğŸŒ è®¿é—®å¿«é€Ÿè®¢é˜…é¡µ";
        const p = sendTgMsg(ctx, title, req, `ç±»å‹: ${clientName}`);
        ctx&&ctx.waitUntil&&ctx.waitUntil(p);
    }
    const isSingbox = ["Sing-box", "Hiddify"].includes(clientName);
    const isClash = ["Clash", "Mihomo", "FlClash"].includes(clientName);

    if(isSingbox&&!isFlagged){
        const t=url.searchParams.get("proxyip");let n=`https://${host}/${SUB_PASSWORD}?flag=true`;t&&(n+=`&proxyip=${encodeURIComponent(t)}`);
        let a=SINGBOX_CONFIG_V12;if(UA.includes("1.11.")||UA.includes("1.10."))a=SINGBOX_CONFIG_V11;
        const s=`${DEFAULT_CONVERTER}/sub?target=singbox&url=${encodeURIComponent(n)}&config=${encodeURIComponent(a)}&emoji=true&list=false&sort=false&fdn=false&scv=false&_t=${now}`,o=await fetch(s);if(!o||!o.headers)return new Response("Conv Error",{status:500});const i=new Headers(o.headers);return i.set("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate"),i.set("Pragma","no-cache"),i.set("Expires","0"),i.set("Content-Type","application/json; charset=utf-8"),new Response(o.body,{status:200,headers:i})
    }
    if(isClash&&!isFlagged){
        const t=url.searchParams.get("proxyip");let n=`https://${host}/${SUB_PASSWORD}?flag=true`;t&&(n+=`&proxyip=${encodeURIComponent(t)}`);const a=`${DEFAULT_CONVERTER}/sub?target=clash&url=${encodeURIComponent(n)}&config=${encodeURIComponent(CLASH_CONFIG)}&emoji=true&list=false&tfo=false&scv=false&fdn=false&sort=false&_t=${now}`,s=await fetch(a);if(!s||!s.headers)return new Response("Conv Error",{status:500});const o=new Headers(s.headers);return o.set("Cache-Control","no-store, no-cache, must-revalidate"),new Response(s.body,{status:200,headers:o})
    }
    let upstream=DEFAULT_SUB_DOMAIN.trim().replace(/^https?:\/\//,"").replace(/\/$/,"");upstream||(upstream=host);let reqProxyIp=url.searchParams.get("proxyip");reqProxyIp||!DEFAULT_PROXY_IP||""===DEFAULT_PROXY_IP.trim()||(reqProxyIp=DEFAULT_PROXY_IP);let targetPath="/";reqProxyIp&&""!==reqProxyIp.trim()&&(targetPath=`/proxyip=${reqProxyIp.trim()}`);const params=new URLSearchParams;params.append("uuid",UUID),params.append("host",upstream),params.append("sni",upstream),params.append("path",targetPath),params.append("type","ws"),params.append("encryption","none"),params.append("security","tls"),params.append("alpn","h3"),params.append("fp","random"),params.append("allowInsecure","1");const upstreamUrl=`https://${upstream}/sub?${params.toString()}`;try{const e=await fetch(upstreamUrl,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}});if(e.ok){const t=await e.text();try{let e=atob(t.trim());return e=e.replace(/path=[^&#]*/g,`path=${encodeURIComponent(targetPath)}`),e=e.replace(/host=[^&]*/g,`host=${host}`),e=e.replace(/sni=[^&]*/g,`sni=${host}`),new Response(btoa(e),{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}catch(e){return new Response(t,{status:200})}}}catch(e){}return new Response("",{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}
if("/sub"===url.pathname){if(url.searchParams.get("uuid")!==UUID)return new Response("Invalid UUID",{status:403});const t=sendTgMsg(ctx,"å¸¸è§„è®¢é˜…è®¿é—® (/sub)",req);return ctx&&ctx.waitUntil&&ctx.waitUntil(t),new Response("",{status:200,headers:{"Content-Type":"text/plain; charset=utf-8"}})}if("websocket"!==req.headers.get("Upgrade")){const t={"Content-Type":"text/html; charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0",Pragma:"no-cache",Expires:"0"};if(WEB_PASSWORD&&WEB_PASSWORD.trim().length>0){const e=req.headers.get("Cookie")||"";if((e.match(/auth=([^;]+)/)?.[1])!==WEB_PASSWORD)return new Response(loginPage(!0),{status:200,headers:t})}return await sendTgMsg(ctx,"âœ… åå°ç™»å½•æˆåŠŸ",req,"è¿›å…¥ç®¡ç†é¢æ¿"),new Response(dashPage(url.hostname,UUID),{status:200,headers:t})}const{proxyIP,socks5,enableSocks,globalProxy}=parseProxyConfig(url.pathname);const{0:c,1:s}=new WebSocketPair;return s.accept(),handle(s,proxyIP,socks5,enableSocks,globalProxy),new Response(null,{status:101,webSocket:c})}catch(e){return new Response(e.toString(),{status:500})}}};;

const handle=(ws,proxyIP,socks5,enableSocks,globalProxy)=>{const pool=new Pool;let sock,w,r,info,first=!0,rxBytes=0,stalls=0,reconns=0;let lastAct=Date.now(),conn=!1,reading=!1;const tmrs={},pend=[];let pendBytes=0,score=1,lastChk=Date.now(),lastRx=0,succ=0,fail=0;let stats={tot:0,cnt:0,big:0,win:0,ts:Date.now()};let mode='adaptive',avgSz=0,tputs=[];const updateMode=s=>{stats.tot+=s;stats.cnt++;if(s>8192)stats.big++;avgSz=avgSz*.9+s*.1;const now=Date.now();if(now-stats.ts>1e3){const rate=stats.win;tputs.push(rate);if(tputs.length>5)tputs.shift();stats.win=s;stats.ts=now;const avg=tputs.reduce((a,b)=>a+b,0)/tputs.length;if(stats.cnt>=20){if(avg<8388608||avgSz<4096){if(mode!=='buffered'){mode='buffered';pool.enableLarge();}}else if(avg>16777216&&avgSz>12288){if(mode!=='direct')mode='direct';}else{if(mode!=='adaptive')mode='adaptive';}}}else{stats.win+=s;}};const readLoop=async()=>{if(reading)return;reading=!0;let batch=[],bSz=0,bTmr=null;const flush=()=>{if(!bSz)return;const m=new Uint8Array(bSz);let p=0;for(const c of batch){m.set(c,p);p+=c.length;}if(ws.readyState===1)ws.send(m);batch=[];bSz=0;if(bTmr){clearTimeout(bTmr);bTmr=null;}};try{while(true){if(pendBytes>MAX_PENDING){await new Promise(res=>setTimeout(res,100));continue;}const{done,value:v}=await r.read();if(v?.length){rxBytes+=v.length;lastAct=Date.now();stalls=0;updateMode(v.length);const now=Date.now();if(now-lastChk>5e3){const el=now-lastChk,by=rxBytes-lastRx,tp=by/el;if(tp>500)score=Math.min(1,score+.05);else if(tp<50)score=Math.max(.1,score-.05);lastChk=now;lastRx=rxBytes;}if(mode==='buffered'){if(v.length<16384){batch.push(v);bSz+=v.length;if(bSz>=65536)flush();else if(!bTmr)bTmr=setTimeout(flush,avgSz>8192?8:25);}else{flush();if(ws.readyState===1)ws.send(v);}}else if(mode==='direct'){flush();if(ws.readyState===1)ws.send(v);}else if(mode==='adaptive'){if(v.length<8192){batch.push(v);bSz+=v.length;if(bSz>=49152)flush();else if(!bTmr)bTmr=setTimeout(flush,12);}else{flush();if(ws.readyState===1)ws.send(v);}}}if(done){flush();reading=!1;reconn();break;}}}catch(e){flush();if(bTmr)clearTimeout(bTmr);reading=!1;fail++;reconn();}};const tryConnect=async(host,port,addressType)=>{if(globalProxy){if(globalProxy.type==='socks5')return await socks5Connect(addressType,host,port,globalProxy.cfg);if(globalProxy.type==='http')return await httpConnect(addressType,host,port,globalProxy.cfg);}try{const socket=connect({hostname:host,port});if(socket.opened)await socket.opened;return socket;}catch(err){if(!socks5&&!proxyIP)throw err;if(socks5){try{const localSocket=enableSocks==='http'?await httpConnect(addressType,host,port,socks5):await socks5Connect(addressType,host,port,socks5);if(localSocket.opened)await localSocket.opened;return localSocket;}catch{}}if(proxyIP){try{const proxySocket=connect({hostname:proxyIP.address,port:proxyIP.port});if(proxySocket.opened)await proxySocket.opened;return proxySocket;}catch{}}throw err;}};const establish=async()=>{try{sock=await tryConnect(info.host,info.port,info.addressType);if(sock.opened)await sock.opened;w=sock.writable.getWriter();r=sock.readable.getReader();const bt=pend.splice(0,10);for(const b of bt){await w.write(b);pendBytes-=b.length;pool.free(b);}conn=!1;reconns=0;score=Math.min(1,score+.15);succ++;lastAct=Date.now();readLoop();}catch(e){conn=!1;fail++;score=Math.max(.1,score-.2);reconn();}};const reconn=async()=>{if(!info||ws.readyState!==1){cleanup();ws.close(1011,'Invalid.');return;}if(reconns>=MAX_RECONN){cleanup();ws.close(1011,'Max reconnect.');return;}if(score<.3&&reconns>5&&Math.random()>.6){cleanup();ws.close(1011,'Poor network.');return;}if(conn)return;reconns++;let d=Math.min(50*Math.pow(1.5,reconns-1),3e3);d*=(1.5-score*.5);d+=(Math.random()-.5)*d*.2;d=Math.max(50,Math.floor(d));try{cleanSock();if(pendBytes>MAX_PENDING*2){while(pendBytes>MAX_PENDING&&pend.length>5){const drop=pend.shift();pendBytes-=drop.length;pool.free(drop);}}await new Promise(res=>setTimeout(res,d));conn=!0;sock=connect({hostname:info.host,port:info.port});await sock.opened;w=sock.writable.getWriter();r=sock.readable.getReader();const bt=pend.splice(0,10);for(const b of bt){await w.write(b);pendBytes-=b.length;pool.free(b);}conn=!1;reconns=0;score=Math.min(1,score+.15);succ++;stalls=0;lastAct=Date.now();readLoop();}catch(e){conn=!1;fail++;score=Math.max(.1,score-.2);if(reconns<MAX_RECONN&&ws.readyState===1)setTimeout(reconn,500);else{cleanup();ws.close(1011,'Exhausted.');}}};const startTmrs=()=>{tmrs.ka=setInterval(async()=>{if(!conn&&w&&Date.now()-lastAct>KEEPALIVE){try{await w.write(new Uint8Array(0));lastAct=Date.now();}catch(e){reconn();}}},KEEPALIVE/3);tmrs.hc=setInterval(()=>{if(!conn&&stats.tot>0&&Date.now()-lastAct>STALL_TO){stalls++;if(stalls>=MAX_STALL){if(reconns<MAX_RECONN){stalls=0;reconn();}else{cleanup();ws.close(1011,'Stall.');}}}},STALL_TO/2);};const cleanSock=()=>{reading=!1;try{w?.releaseLock();r?.releaseLock();sock?.close();}catch{}};const cleanup=()=>{Object.values(tmrs).forEach(clearInterval);cleanSock();while(pend.length)pool.free(pend.shift());pendBytes=0;stats={tot:0,cnt:0,big:0,win:0,ts:Date.now()};mode='adaptive';avgSz=0;tputs=[];pool.reset();};ws.addEventListener('message',async e=>{try{if(first){first=!1;const b=new Uint8Array(e.data);if(buildUUID(b,1)!==UUID)throw new Error('Auth failed');const{host,port,payload,addressType}=extractAddr(b);info={host,port,addressType};ws.send(new Uint8Array([b[0],0]));conn=!0;if(payload.length){const buf=pool.alloc(payload.length);buf.set(payload);pend.push(buf);pendBytes+=buf.length;}startTmrs();establish();}else{lastAct=Date.now();if(conn||!w){const buf=pool.alloc(e.data.byteLength);buf.set(new Uint8Array(e.data));pend.push(buf);pendBytes+=buf.length;}else{await w.write(e.data);}}}catch(err){cleanup();ws.close(1006,'Error.');}});ws.addEventListener('close',cleanup);ws.addEventListener('error',cleanup);};

// UI
function loginPage(e){return`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Worker Login</title><style>body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-family:'Segoe UI',sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}.glass-box{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);padding:40px;border-radius:16px;box-shadow:0 8px 32px 0 rgba(31,38,135,.37);text-align:center;width:320px}h2{margin-top:0;margin-bottom:20px;font-weight:600;letter-spacing:1px}input{width:100%;padding:14px;margin-bottom:20px;border-radius:8px;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.2);color:#fff;box-sizing:border-box;text-align:center;font-size:1rem;outline:none;transition:.3s}input:focus{background:rgba(0,0,0,.4);border-color:#a29bfe}button{width:100%;padding:12px;border-radius:8px;border:none;background:linear-gradient(90deg,#a29bfe,#6c5ce7);color:#fff;font-weight:700;cursor:pointer;font-size:1rem;box-shadow:0 4px 15px rgba(0,0,0,.2);transition:.2s}button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}.social-links{margin-top:25px;display:flex;justify-content:center;gap:15px;border-top:1px solid rgba(255,255,255,.1);padding-top:20px;flex-wrap:wrap}.social-links a{color:#e2e8f0;text-decoration:none;font-size:.9rem;padding:8px 16px;background:rgba(0,0,0,.2);border-radius:20px;border:1px solid rgba(255,255,255,.15);transition:.2s;display:flex;align-items:center;gap:5px}.social-links a:hover{background:rgba(255,255,255,.2);transform:translateY(-2px);border-color:#a29bfe}.error-msg{background:rgba(231,76,60,.3);border:1px solid rgba(231,76,60,.5);color:#ff7675;padding:10px;border-radius:8px;margin-bottom:15px;font-size:.9rem;display:${e?"block":"none"}}</style></head><body><div class="glass-box"><h2>ğŸ”’ ç¦æ­¢è¿›å…¥</h2><div class="error-msg">âš ï¸ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div><input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç " autofocus onkeypress="if(event.keyCode===13)verify()"><button onclick="verify()">è§£é”åå°</button><div class="social-links"><a href="javascript:void(0)" onclick="gh()">ğŸ”¥ çƒˆç«é¡¹ç›®ç›´è¾¾</a><a href="${TG_CHANNEL_URL}" target="_blank">ğŸ“¢ å¤©è¯šé¢‘é“ç»„</a><a href="${TG_GROUP_URL}" target="_blank">âœˆï¸ å¤©è¯šäº¤æµç¾¤</a></div></div><script>function gh(){fetch("?flag=github&t="+Date.now(),{keepalive:!0});window.open("https://github.com/xtgm/stallTCP1.3V1","_blank")}function verify(){const p=document.getElementById("pwd").value,d=new Date;d.setTime(d.getTime()+6048e5),document.cookie="auth="+p+";expires="+d.toUTCString()+";path=/",location.reload()}<\/script></body></html>`}
function dashPage(e,t){const s=TG_BOT_TOKEN&&TG_CHAT_ID?'<div class="status-item available">ğŸ¤– Telegram é€šçŸ¥: <span style="color:#00b894;font-weight:bold">å·²å¼€å¯</span></div>':'<div class="status-item">ğŸ¤– Telegram é€šçŸ¥: <span style="color:#fab1a0">æœªé…ç½®</span></div>';return`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Worker è®¢é˜…ç®¡ç†</title><style>:root{--glass:rgba(255,255,255,.1);--border:rgba(255,255,255,.2)}body{background:linear-gradient(135deg,#2b1055 0%,#7597de 100%);color:#fff;font-family:'Segoe UI',system-ui,sans-serif;margin:0;padding:20px;min-height:100vh;display:flex;justify-content:center;box-sizing:border-box}.container{max-width:800px;width:100%}.card{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:16px;padding:25px;margin-bottom:20px;box-shadow:0 8px 32px 0 rgba(0,0,0,.3)}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--border)}h1{margin:0;font-size:1.5rem;font-weight:600;text-shadow:0 2px 4px rgba(0,0,0,.3)}h3{margin-top:0;font-size:1.1rem;border-bottom:1px solid var(--border);padding-bottom:10px;color:#dfe6e9}.btn-group{display:flex;gap:10px}.btn-small{font-size:.85rem;cursor:pointer;background:rgba(0,0,0,.3);padding:5px 12px;border-radius:6px;text-decoration:none;color:#fff;transition:.2s;border:1px solid transparent}.btn-small:hover{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.5)}.field{margin-bottom:18px}.label{display:block;font-size:.9rem;color:#dfe6e9;margin-bottom:8px;font-weight:500}.input-group{display:flex;gap:10px}input,textarea{width:100%;background:rgba(0,0,0,.25);border:1px solid var(--border);color:#fff;padding:12px;border-radius:8px;font-family:monospace;outline:none;transition:.2s;box-sizing:border-box}input:focus,textarea:focus{background:rgba(0,0,0,.4);border-color:#a29bfe}textarea{min-height:120px;resize:vertical;line-height:1.4}button.main-btn{background:linear-gradient(90deg,#6c5ce7,#a29bfe);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;width:100%;margin-top:5px;transition:.2s;box-shadow:0 4px 6px rgba(0,0,0,.2);font-size:1rem}button.main-btn:hover{transform:translateY(-2px);opacity:.95}button.sec-btn{background:rgba(255,255,255,.15);color:#fff;border:1px solid var(--border);padding:12px;border-radius:8px;cursor:pointer;white-space:nowrap;transition:.2s}button.sec-btn:hover{background:rgba(255,255,255,.3)}.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#00b894;color:#fff;padding:10px 24px;border-radius:30px;opacity:0;transition:.3s;pointer-events:none;box-shadow:0 5px 15px rgba(0,0,0,.3);font-weight:700}.toast.show{opacity:1;bottom:50px}.desc{font-size:.8rem;color:#b2bec3;margin-top:6px}.checkbox-wrapper{display:flex;align-items:center;margin-top:10px;background:rgba(0,0,0,.2);padding:8px 12px;border-radius:6px;width:fit-content}.checkbox-wrapper input{width:auto;margin-right:8px;cursor:pointer}.checkbox-wrapper label{cursor:pointer;font-size:.9rem;color:#dfe6e9}.status-item{background:rgba(0,0,0,.2);padding:8px 12px;border-radius:6px;font-size:.9rem;margin-top:10px;display:inline-block}</style></head><body><div class="container"><div class="card"><div class="header"><h1>âš¡ Worker ç®¡ç†é¢æ¿</h1><div class="btn-group"><a href="${TG_GROUP_URL}" target="_blank" class="btn-small">âœˆï¸ åŠ å…¥ç¾¤ç»„</a><span class="btn-small" onclick="logout()">é€€å‡ºç™»å½•</span></div></div><div style="margin-bottom:20px;text-align:center">${s}</div><div class="field" style="background:rgba(108,92,231,.2);padding:15px;border-radius:10px;border:1px solid rgba(162,155,254,.4)"><span class="label" style="color:#a29bfe;font-weight:700">ğŸš€ å¿«é€Ÿè‡ªé€‚åº”è®¢é˜… (æ¨è) é€šç”¨è®¢é˜…å¤åˆ¶è¿™é‡Œ</span><div class="input-group"><input type="text" id="shortSub" value="https://${e}/${SUB_PASSWORD}" readonly onclick="this.select()"><button class="sec-btn" onclick="copyId('shortSub')">å¤åˆ¶</button></div><div class="desc">ç›´æ¥ä½¿ç”¨æ­¤é“¾æ¥ã€‚æ”¯æŒé€šç”¨è®¢é˜…å®¢æˆ·ç«¯(è‡ªé€‚åº”å®¢æˆ·ç«¯è®¢é˜…)ã€‚<br/>èŠ‚ç‚¹å°†è‡ªåŠ¨æŠ“å–ä¸Šæ¸¸å¹¶æ›¿æ¢ä¸ºWorkeråŠ é€Ÿã€‚</div><div style="margin-top:10px;font-size:.9rem;color:#ff4757;font-weight:700;text-align:center">ã€â†“ä¸‹æ–¹çš„å¯ä¿®æ”¹å†…å®¹æŒ‡å‘æ‰‹åŠ¨è®¢é˜…é“¾æ¥ã€‘</div></div><div class="field"><span class="label">1. è®¢é˜…æ•°æ®æº (Subä¼˜é€‰è®¢é˜…å™¨å¤„)</span><input type="text" id="subBaseUrl" value="https://${DEFAULT_SUB_DOMAIN}" placeholder="https://ä½ çš„subåœ°å€æˆ–è€…æ˜¯workeråŸŸååœ°å€" oninput="updateLink()"><div class="desc">è¿™é‡Œå¯ä¿®æ”¹æˆä½ çš„subåœ°å€æˆ–è€…æ˜¯ä½ çš„workeråŸŸååœ°å€ã€‚</div></div><div class="field"><span class="label">2.Proxyipä¿®æ”¹å¤„ (ProxyIP)</span><div class="input-group"><input type="text" id="proxyIp" value="${DEFAULT_PROXY_IP}" placeholder="ä¾‹å¦‚: ä½ çš„proxyipåœ°å€" oninput="updateLink()"><button class="sec-btn" onclick="checkProxy()">ğŸ” æ£€æµ‹</button></div><div class="desc">è¿™é‡Œå†³å®šäº†ä½ çš„proxyipåœ°å€ï¼Œè°¨æ…ä¿®æ”¹æ­£ç¡®çš„proxyipåœ°å€å†…å®¹ã€‚</div></div><div class="field" id="clashSettings" style="display:none;background:rgba(0,0,0,.15);padding:15px;border-radius:8px;margin-bottom:18px;border:1px dashed #6c5ce7"><span class="label" style="color:#a29bfe">âš™ï¸ Clash é«˜çº§é…ç½®</span><div style="margin-bottom:10px"><span class="label" style="font-size:.85rem">è½¬æ¢åç«¯:</span><input type="text" id="converterUrl" value="${DEFAULT_CONVERTER}" oninput="updateLink()"></div><div><span class="label" style="font-size:.85rem">è¿œç¨‹é…ç½®:</span><input type="text" id="configUrl" value="https://raw.githubusercontent.com/sinspired/sub-store-template/main/1.12.x/sing-box.json" oninput="updateLink()"></div></div><div class="field"><span class="label">3. æ‰‹åŠ¨ç”Ÿæˆè®¢é˜…é“¾æ¥ (Legacy)</span><input type="text" id="resultUrl" readonly onclick="this.select()"><div class="checkbox-wrapper"><input type="checkbox" id="clashMode" onchange="toggleClashMode()"><label for="clashMode">ğŸ”„ å¼€å¯ Clash è½¬æ¢</label></div></div><div class="input-group"><button class="main-btn" onclick="testSub()">ğŸ“„ å¤åˆ¶è®¢é˜…é“¾æ¥</button><button class="sec-btn" onclick="testSub(true)" style="width:120px">ğŸš€ æµ‹è¯•</button></div></div></div><div id="toast" class="toast">å·²å¤åˆ¶!</div><script>function toggleClashMode(){const e=document.getElementById("clashMode").checked;document.getElementById("clashSettings").style.display=e?"block":"none",updateLink()}function updateLink(){let e=document.getElementById("subBaseUrl").value.trim();e.endsWith("/")&&(e=e.slice(0,-1)),e.startsWith("http")||(e="https://"+e);const t=document.getElementById("proxyIp").value.trim(),s="${t}",h="${e}",n=document.getElementById("clashMode").checked;let r="/";t&&(r="/proxyip="+t);const o=e+"/sub?uuid="+s+"&encryption=none&security=tls&sni="+h+"&alpn=h3&fp=random&allowInsecure=1&type=ws&host="+h+"&path="+encodeURIComponent(r);if(n){let e=document.getElementById("converterUrl").value.trim();e.endsWith("/")&&(e=e.slice(0,-1));const t=document.getElementById("configUrl").value.trim();let s=t?"&config="+encodeURIComponent(t):"";document.getElementById("resultUrl").value=e+"/sub?target=clash&url="+encodeURIComponent(o)+s+"&emoji=true&list=false&tfo=false&scv=false&fdn=false&sort=false"}else document.getElementById("resultUrl").value=o}function copyId(e){navigator.clipboard.writeText(document.getElementById(e).value).then((()=>showToast("å·²å¤åˆ¶!")))}function checkProxy(){const e=document.getElementById("proxyIp").value.trim();fetch("?flag=proxycheck");if(e){navigator.clipboard.writeText(e).then((()=>{alert("ProxyIP å·²å¤åˆ¶!"),window.open("${PROXY_CHECK_URL}","_blank")}))}else{window.open("${PROXY_CHECK_URL}","_blank")}}function testSub(isTest){const e=document.getElementById("resultUrl").value;if(isTest){fetch("?flag=test");if(e) window.open(e, "_blank")}else{copyId('resultUrl')}}function showToast(e){const t=document.getElementById("toast");t.innerText=e,t.classList.add("show"),setTimeout((()=>t.classList.remove("show")),2e3)}function logout(){document.cookie="auth=;expires=Thu,01 Jan 1970 00:00:00 UTC;path=/;",location.reload()}window.onload=()=>{updateLink()};<\/script></body></html>`}
